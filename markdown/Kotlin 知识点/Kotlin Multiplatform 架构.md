# Kotlin Multiplatform 架构

Kotlin 官方明确支持三大平台：JVM 平台、JavaScript 平台、Native 平台。

JVM 平台（Android、服务器、桌面 Java）：通过 Kotlin/JVM 输出 JVM 字节码，在 JVM 上运行。

JavaScript 平台（浏览器、Node.js）：通过 Kotlin/JS 输出 JavaScript 源代码，在浏览器或 Node.js 上运行。

Native 平台（iOS、Windows、Linux、WASM）：通过 Kotlin/Native 输出 LLVM IR 再编译成机器码，在
iOS、Windows、Linux、WASM 上运行。

## Kotlin Multiplatform 架构图

```text
                         ┌───────────────────────────────┐
                         │        Kotlin 源代码           │
                         └───────────────────────────────┘
                                         │
                                         ▼
                         ┌───────────────────────────────┐
                         │   Kotlin 前端（Parser + AST）  │
                         │   - 词法分析 / 语法分析         │
                         │   - 类型检查                   │
                         └───────────────────────────────┘
                                         │
                                         ▼
                         ┌───────────────────────────────┐
                         │   Kotlin IR（中间表示）         │
                         │   ★ 三大后端共享的核心层         │
                         └───────────────────────────────┘
                                         │
      ┌──────────────────────────────────┼──────────────────────────────────┐
      ▼                                  ▼                                  ▼
┌──────────────────────┐      ┌──────────────────────┐          ┌────────────────────────┐
│   Kotlin/JVM 后端     │      │    Kotlin/JS 后端     │          │   Kotlin/Native 后端   │
│   - 生成 JVM 字节码    │      │    - 生成 JS AST      │          │   - 生成 LLVM IR       │
│   - 输出 .class/.jar  │      │    - 输出 JavaScript  │          │   - 交给 LLVM 编译机器码 │
└──────────────────────┘      └──────────────────────┘          └────────────────────────┘
│                                  │                                  │
▼                                  ▼                                  ▼
┌──────────────────────┐      ┌──────────────────────┐          ┌────────────────────────┐
│   JVM（HotSpot/ART）  │      │   JS 引擎（V8/JSCore）│          │   LLVM 优化器 + CodeGen  │
│   - JIT/AOT          │      │   - JIT 编译          │          │   - ARM64 / x86_64 / WASM │
└──────────────────────┘      └──────────────────────┘          └────────────────────────┘
│                                  │                                  │
▼                                  ▼                                  ▼
┌──────────────────────┐      ┌──────────────────────┐          ┌────────────────────────┐
│   JVM 字节码执行       │      │   JavaScript 执行     │          │   原生二进制执行         │
│   Android / Desktop  │      │   浏览器 / Node.js    │          │   iOS / Windows / Linux │
└──────────────────────┘      └──────────────────────┘          └────────────────────────┘
```

## LLVM

LLVM 是一个“通用编译器底层平台”，它把各种语言编译成一种统一的中间格式（LLVM IR），再把它编译成各种 CPU
的机器码，最后打包成二进制文件。

机器码是 CPU 能执行的指令序列，二进制文件是把机器码 + 元数据 + 符号表 +
段信息打包成一个可执行文件格式，所以机器码是内容，二进制文件是容器。

```text
源代码（Kotlin/Swift/Rust/C/C++）
        ↓
语言前端（Parser）
        ↓
LLVM IR（平台无关）
        ↓
LLVM 后端（Codegen）
        ↓
机器码（ARM64 / x86_64 / WebAssembly）
        ↓
二进制（.exe / .app / .so / .wasm）
```

### 机器码不是通用的，它是 CPU 架构专属的指令集。

| CPU 架构 | 平台                       | 指令集         | 机器码是否兼容       |
|--------|--------------------------|-------------|---------------|
| ARM64  | iOS / Android / 部分 Linux | AArch64     | ✔ ARM64 之间兼容  |
| x86_64 | Windows / Linux / macOS  | x86-64      | ✔ x86_64 之间兼容 |
| ARMv7  | 老 Android                | ARM32       | ❌ 不兼容 ARM64   |
| WASM   | 浏览器 / WASI               | WebAssembly | ❌ 不兼容 ARM/x86 |

## Kotlin/Native + LLVM 转换成二进制

```text
Kotlin 源码
    ↓
Kotlin 前端（解析、类型检查）
    ↓
Kotlin IR（中间表示）
    ↓
Kotlin/Native 后端
    ↓
LLVM IR（平台无关）
    ↓
LLVM 优化器（优化代码）
    ↓
LLVM CodeGen（生成机器码）
    ↓
二进制（.exe / .app / .so / .wasm）

```

## Kotlin/JS 转换成 JavaScript

```text
Kotlin 源码
    ↓
Kotlin 前端（解析、类型检查）
    ↓
Kotlin IR（中间表示）
    ↓
Kotlin/JS 后端
    ↓
JavaScript AST（语法树）
    ↓
生成 JavaScript 代码（ES5/ES2015+）

```

## Kotlin 跨平台应用架构

```text
                           ┌──────────────────────────────────┐
                           │        Shared KMP Module         │
                           │  （纯 Kotlin，可被所有平台复用） │
                           └──────────────────────────────────┘
                                        ▲
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
         ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
         │   Android App    │  │     iOS App      │  │   Desktop/Web    │
         └──────────────────┘  └──────────────────┘  └──────────────────┘
                    │                   │                   │
                    ▼                   ▼                   ▼
         ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
         │   Android UI     │  │     SwiftUI      │  │   Compose/Web UI │
         │ (Compose/Views)  │  │                  │  │                  │
         └──────────────────┘  └──────────────────┘  └──────────────────┘
                    ▲                   ▲                   ▲
                    │                   │                   │
                    └──────────────┬────┴───────┬──────────┘
                                   ▼             ▼
                         ┌──────────────────────────────────┐
                         │        KMP ViewModel Layer       │
                         │  - StateHolder                   │
                         │  - Business Orchestration        │
                         └──────────────────────────────────┘
                                   ▲
                                   │
                         ┌──────────────────────────────────┐
                         │        Domain Layer (KMP)        │
                         │  - UseCase（业务动作）             │
                         │  - Entity（业务数据结构）           │ 
                         └──────────────────────────────────┘
                                   ▲
                                   │
                         ┌──────────────────────────────────┐
                         │     Repository Interface (KMP)   │
                         │  - 定义数据访问抽象                 │
                         │  - 不包含平台实现                   │
                         └──────────────────────────────────┘
                                   ▲
                                   │
         ┌─────────────────────────┼──────────────────────────┐
         │                         │                          │
         ▼                         ▼                          ▼
┌──────────────────┐   ┌──────────────────┐      ┌──────────────────┐
│ Android Repo Impl│   │   iOS Repo Impl  │      │ Desktop/Web Impl │
│ - Retrofit/Room  │   │ - Ktor/SQLDelight│      │ - Ktor/Local FS  │
└──────────────────┘   └──────────────────┘      └──────────────────┘
         ▲                         ▲                          ▲
         │                         │                          │
         ▼                         ▼                          ▼
┌──────────────────┐   ┌──────────────────┐      ┌──────────────────┐
│ Android DataSrc  │   │   iOS DataSrc    │      │ Desktop/Web DS   │
│ - System API     │   │ - System API     │      │ - Browser/FS API │
│ - Network/DB     │   │ - Network/DB     │      │ - Network/DB     │
└──────────────────┘   └──────────────────┘      └──────────────────┘

```